<script>
let currentPage = 1;
let articleCount = 0;
let loading = false;

async function loadResults(reset = false){

  const urlParams = new URLSearchParams(window.location.search);
  const query = urlParams.get("q");
  if(!query) return;

  if(reset){
    currentPage = 1;
    articleCount = 0;
    document.getElementById("journalResults").innerHTML = "";
  }

  loading = true;
  document.getElementById("loadMoreBtn").innerText = "Loading...";

  try{

    const response = await fetch(window.location.origin + `/api/search?q=${query}&page=${currentPage}`);
    const data = await response.json();

    const resultDiv = document.getElementById("journalResults");
    let html = "";

    const crossref = data.crossref || [];
    const openalex = data.openalex || [];
    const semantic = data.semantic || [];
    const doaj = data.doaj || [];
    const arxiv = data.arxiv || [];

    const maxLength = Math.max(
      crossref.length,
      openalex.length,
      semantic.length,
      doaj.length,
      arxiv.length
    );

    for(let i = 0; i < maxLength; i++){

      if(crossref[i]){
        const item = crossref[i];
        articleCount++;
        html += renderCard({
          number: articleCount,
          source: "Crossref",
          title: item.title?.[0],
          authors: item.author?.map(a=>a.given+" "+a.family).join(", "),
          journal: item['container-title']?.[0],
          volume: item.volume,
          issue: item.issue,
          issn: item.ISSN?.join(", "),
          year: item.created?.["date-parts"]?.[0]?.[0],
          abstract: item.abstract,
          keywords: "",
          doi: item.DOI,
          articleUrl: item.DOI ? `https://doi.org/${item.DOI}` : ""
        });
      }

      if(openalex[i]){
        const item = openalex[i];
        articleCount++;
        html += renderCard({
          number: articleCount,
          source: "OpenAlex",
          title: item.title,
          authors: item.authorships?.map(a=>a.author.display_name).join(", "),
          journal: item.host_venue?.display_name,
          volume: item.biblio?.volume,
          issue: item.biblio?.issue,
          issn: item.host_venue?.issn_l,
          year: item.publication_year,
          abstract: "",
          keywords: item.concepts?.map(c=>c.display_name).join(", "),
          doi: item.doi,
          articleUrl: item.doi
        });
      }

      if(semantic[i]){
        const item = semantic[i];
        articleCount++;
        html += renderCard({
          number: articleCount,
          source: "Semantic Scholar",
          title: item.title,
          authors: item.authors?.map(a=>a.name).join(", "),
          journal: item.venue,
          volume: "",
          issue: "",
          issn: "",
          year: item.year,
          abstract: item.abstract,
          keywords: item.keywords?.map(k=>k.name).join(", "),
          doi: item.externalIds?.DOI,
          articleUrl: item.url
        });
      }

      if(doaj[i]){
        const item = doaj[i];
        const bib = item.bibjson || {};
        articleCount++;
        html += renderCard({
          number: articleCount,
          source: "DOAJ",
          title: bib.title,
          authors: bib.author?.map(a=>a.name).join(", "),
          journal: bib.journal?.title,
          volume: bib.journal?.volume,
          issue: bib.journal?.number,
          issn: bib.journal?.issn?.join(", "),
          year: bib.year,
          abstract: bib.abstract,
          keywords: bib.keywords?.join(", "),
          doi: bib.identifier?.find(id=>id.type==="doi")?.id,
          articleUrl: bib.link?.[0]?.url
        });
      }

      if(arxiv[i]){
        const item = arxiv[i];
        articleCount++;
        html += renderCard({
          number: articleCount,
          source: "arXiv",
          title: item.title,
          authors: item.authors,
          journal: "arXiv Preprint",
          volume: "",
          issue: "",
          issn: "",
          year: item.year,
          abstract: item.abstract,
          keywords: "",
          doi: "",
          articleUrl: item.link
        });
      }

    }

    resultDiv.innerHTML += html;

    if(!html){
      document.getElementById("loadMoreBtn").innerText = "No More Results";
      loading = true;
      return;
    }

    loading = false;
    document.getElementById("loadMoreBtn").innerText = "Load More";

  } catch(error){
    console.error(error);
    document.getElementById("loadMoreBtn").innerText = "Error";
  }
}

function renderCard(data){

  let readLink = "";

  if(data.doi){
    readLink = "https://doi.org/" + data.doi.replace(/^https?:\/\/doi\.org\//,'');
  } else if(data.articleUrl){
    readLink = data.articleUrl;
  }

  return `
  <div class="result-card">
    <div class="result-source">
      #${data.number} • ${data.source}
    </div>

    <div class="result-title">
      ${data.title || "No Title"}
    </div>

    <div class="result-meta"><strong>Authors:</strong> ${data.authors || "N/A"}</div>
    <div class="result-meta"><strong>Journal:</strong> ${data.journal || "N/A"}</div>
    <div class="result-meta">
      <strong>Volume:</strong> ${data.volume || "N/A"} |
      <strong>Issue:</strong> ${data.issue || "N/A"}
    </div>
    <div class="result-meta"><strong>ISSN:</strong> ${data.issn || "N/A"}</div>
    <div class="result-meta"><strong>Year:</strong> ${data.year || "N/A"}</div>

    ${data.abstract ? `
      <div class="abstract-box">
        <strong>Abstract:</strong> ${data.abstract}
      </div>` : ""}

    ${data.keywords ? `
      <div class="keyword-box">
        <strong>Keywords:</strong> ${data.keywords}
      </div>` : ""}

    ${readLink ? `
      <a href="${readLink}" target="_blank" class="read-btn">
        Visit Article →
      </a>` : ""}
  </div>
  `;
}

document.getElementById("loadMoreBtn").addEventListener("click",()=>{
  if(loading) return;
  currentPage++;
  loadResults();
});

loadResults(true);
</script>
